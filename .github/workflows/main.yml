name: Run Playwright Scripts MAIN (Debug)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  build-and-push-docker-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          IMAGE_NAME="playwright-scraper"
          # Use github.repository_owner and convert to lowercase
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          TAG="ghcr.io/${REPO_OWNER_LOWER}/${IMAGE_NAME}:latest"
          
          echo "Building and pushing Docker image: $TAG"
          
          docker buildx build . --push --tag "$TAG"
          
          # Explicitly set DOCKER_IMAGE_TAG for subsequent steps
          echo "DOCKER_IMAGE_TAG=${TAG}" >> $GITHUB_ENV

  run-main-script:
    runs-on: ubuntu-latest
    needs: build-and-push-docker-image # Ensure Docker image is built first
    container:
      image: ghcr.io/${{ github.repository_owner | lower }}/playwright-scraper:latest # Use lowercase owner name here
    permissions:
      contents: write

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Run master script with private scripts
        run: python master_script.py
        env:
          FSTVL_SCRIPT: ${{ secrets.FSTVL_SCRIPT }}
          PPV_SCRIPT: ${{ secrets.PPV }}
          WEARECHECKING_SCRIPT: ${{ secrets.WEARECHECKING_SCRIPT }}
          STREAMBTW_SCRIPT: ${{ secrets.STREAMBTW_SCRIPT }}
          OVOGOALS_SCRIPT: ${{ secrets.OVOGOALS_SCRIPT }}
          LocalChannels: ${{ secrets.LOCALCHANNELS }}

      - name: Upload file to Dropbox
        uses: gomes042/gh-actions-dropbox/files/upload@23ce81287e83f01c19c9f60b1849b746db6616b5
        with:
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          source_path: MyStuff/MyStuff.m3u
          DEST_PATH: /MyStuff/MyStuff.m3u
