name: Combined Playlist Update

on:
  workflow_dispatch:
  schedule:
    # Runs every 40 minutes past the hour.
    - cron: '*/40 * * * *'

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    container:
      # Use a Playwright container with all necessary dependencies.
      image: mcr.microsoft.com/playwright:v1.55.0-noble
    env:
      HOME: /root # This is crucial to fix permissions and sandbox issues inside the container.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies and set up Python virtual environment
        run: |
          # Update package list and install unzip and python3-venv.
          apt-get update
          apt-get install -y python3-venv
          
          # Create and activate a Python virtual environment.
          python3 -m venv venv
          source venv/bin/activate
          
          # Upgrade pip and install all required Python packages.
          python -m pip install --upgrade pip
          pip install playwright==1.55.0 aiohttp dropbox httpx requests
        shell: bash

      - name: Download scripts and channels.txt
        run: |
          # Use curl to download each script from its unique tinyurl link.
          curl -L -o FSC.py "https://tinyurl.com/m4evvh4v"
          curl -L -o FS.py "https://tinyurl.com/mv5ew6m5"
          curl -L -o PP.py "https://tinyurl.com/muuurv94"
          curl -L -o TML.py "https://tinyurl.com/mrmtxffk"
          curl -L -o WC.py "https://tinyurl.com/35jt8wtm"
          
          # Download the channels.txt file from the specified URL.
          curl -L -o channels.txt "https://tinyurl.com/4ze5nm6p"
        shell: bash

      - name: Run Python scripts and combine outputs
        run: |
          # Activate the virtual environment to ensure all installed packages are available.
          source venv/bin/activate
          
          # Start the main playlist file with the #EXTM3U header.
          echo "#EXTM3U" > MyStuff.m3u

          # Define an associative array to map each script to its expected output filename.
          declare -A script_outputs
          script_outputs=(
            ["FSC.py"]="S1.m3u"
            ["FS.py"]="S2.m3u8"
            ["PP.py"]="S3.m3u"
            ["TML.py"]="S4.m3u8"
            ["WC.py"]="S5.m3u8"
          )

          # Loop through each script, run it, and append its output to the main playlist.
          for script in "${!script_outputs[@]}"; do
            echo "Running $script..."
            # Run the script from the current directory. Use || to continue if a script fails.
            python "$script" || echo "⚠️ $script failed but continuing..."
            
            output_file="${script_outputs[$script]}"
            if [ -f "$output_file" ]; then
              echo "Appending $output_file to MyStuff.m3u, skipping first 10 lines"
              # Use tail -n +11 to skip the first 10 lines of each individual playlist.
              tail -n +11 "$output_file" >> MyStuff.m3u
            else
              echo "⚠️ $output_file not found, skipping"
            fi
          done

          # Fetch and append remote playlists from channels.txt
          echo "Fetching remote playlists from channels.txt..."
          if [ -f "channels.txt" ]; then
            while read -r url; do
              # Ensure the line is not empty and doesn't start with a # (a comment).
              if [[ ! -z "$url" && ! "$url" =~ ^# ]]; then
                echo "Downloading $url..."
                # Use curl to download and tail to skip the first 10 lines before appending.
                curl -sL "$url" | tail -n +11 >> MyStuff.m3u || echo "⚠️ Failed to download $url"
              fi
            done < "channels.txt"
          else
            echo "⚠️ channels.txt not found, skipping remote playlist download."
          fi
        shell: bash

      - name: Upload combined playlist to Dropbox
        # Use a third-party action to securely upload the final playlist.
        uses: gomes042/gh-actions-dropbox/files/upload@23ce81287e83f01c19c9f60b1849b746db6616b5
        with:
          # Use GitHub secrets to authenticate with Dropbox.
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          # Specify the source file to upload and the destination path in Dropbox.
          source_path: MyStuff.m3u
          DEST_PATH: /MyStuff/MyStuff.m3u

     # - name: Signal success to Cronitor
      #  run: curl --silent "https://cronitor.link/p/2a7e1594aaf843d0ab2a037849f79ec2/playwright-main"
